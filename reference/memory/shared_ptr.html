<h1>shared_ptr (C++11)</h1>
<p><pre class="codehilite"><code class="language-cpp"><span style="color: #000">namespace std {
  template &lt;class T&gt;
  class shared_ptr;
}</span></code></pre>
</p>
<h2>概要</h2>
<p><code><span style="color: #000">shared_ptr</span></code>は、指定されたリソースへの所有権(ownership)を共有(share)するスマートポインタである。</p>
<p>複数の<code><span style="color: #000">shared_ptr</span></code>オブジェクトが同じリソースを共有し、所有者が0人、つまりどの<code><span style="color: #000">shared_ptr</span></code>オブジェクトからもリソースが参照されなくなると、リソースが自動的に解放される。</p>
<h3>参照カウント</h3>
<p><code><span style="color: #000">shared_ptr</span></code>は「参照カウント(reference count)」によって実装される。</p>
<p><code><span style="color: #000">shared_ptr</span></code>オブジェクトのコピー構築、コピー代入が行われるとカウントが1増える。デストラクタが実行されるとカウントが1減る。そしてカウントが0になると、自動的に「<code><span style="color: #000">delete p;</span></code>」が実行され、リソースが解放される。</p>
<h3>スレッド安全性</h3>
<p><code><span style="color: #000">shared_ptr</span></code>の参照カウンタはスレッドセーフである。つまり、スレッドを跨いで<code><span style="color: #000">shared_ptr</span></code>をコピーし、リソースを共有することが安全にできる。</p>
<p>非スレッドセーフに参照カウントを増減させる方法はない。シングルスレッドでのパフォーマンスが重要で、スレッドセーフであることによるオーバーヘッドが問題になる場合、ムーブを活用すればパフォーマンスを改善できる。</p>
<h2>メンバ関数</h2>
<table border="1" bordercolor="#888" style="border-collapse:collapse">
<thead>
<tr>
<th>名前</th>
<th>説明</th>
<th>対応バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/shared_ptr.html"><code><span style="color: #000">(constructor)</span></code></a></td>
<td>コンストラクタ</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/-shared_ptr.html"><code><span style="color: #000">(destructor)</span></code></a></td>
<td>デストラクタ</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_assign.html"><code><span style="color: #000">operator=</span></code></a></td>
<td>代入演算子</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/reset.html"><code><span style="color: #000">reset</span></code></a></td>
<td>所有権を放棄し、新たな所有権を設定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/swap.html"><code><span style="color: #000">swap</span></code></a></td>
<td>他の<code><span style="color: #000">shared_ptr</span></code>オブジェクトとデータを入れ替える</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/get.html"><code><span style="color: #000">get</span></code></a></td>
<td>リソースを取得する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_deref.html"><code><span style="color: #000">operator*</span></code></a></td>
<td>間接参照</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_arrow.html"><code><span style="color: #000">operator-&gt;</span></code></a></td>
<td>メンバアクセス</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/use_count.html"><code><span style="color: #000">use_count</span></code></a></td>
<td>所有権を持つユーザー数を取得する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/unique.html"><code><span style="color: #000">unique</span></code></a></td>
<td>所有権を持つユーザーが一人だけかを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_bool.html"><code><span style="color: #000">operator bool</span></code></a></td>
<td>有効なリソースを所有しているかを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/owner_before.html"><code><span style="color: #000">owner_before</span></code></a></td>
<td>所有権ベースでの小なり比較を行う</td>
<td>C++11</td>
</tr>
</tbody>
</table>
<h2>メンバ型</h2>
<table border="1" bordercolor="#888" style="border-collapse:collapse">
<thead>
<tr>
<th>名前</th>
<th>説明</th>
<th>対応バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td><code><span style="color: #000">element_type</span></code></td>
<td>管理するインスタンスの型<code><span style="color: #000">T</span></code></td>
<td>C++11</td>
</tr>
</tbody>
</table>
<h2>非メンバ関数</h2>
<table border="1" bordercolor="#888" style="border-collapse:collapse">
<thead>
<tr>
<th>名前</th>
<th>説明</th>
<th>対応バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_equal.html"><code><span style="color: #000">operator==</span></code></a></td>
<td>等値比較</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_not_equal.html"><code><span style="color: #000">operator!=</span></code></a></td>
<td>非等値比較</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_less.html"><code><span style="color: #000">operator&lt;</span></code></a></td>
<td>左辺が右辺より小さいかを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_less_equal.html"><code><span style="color: #000">operator&lt;=</span></code></a></td>
<td>左辺が右辺以下かを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_greater.html"><code><span style="color: #000">operator&gt;</span></code></a></td>
<td>左辺が右辺より大きいかを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_greater_equal.html"><code><span style="color: #000">operator&gt;=</span></code></a></td>
<td>左辺が右辺以上かを判定する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/swap_free.html"><code><span style="color: #000">swap</span></code></a></td>
<td>2つの<code><span style="color: #000">shared_ptr</span></code>オブジェクトを入れ替える</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/get_deleter.html"><code><span style="color: #000">get_deleter</span></code></a></td>
<td>デリータを取得する</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/op_ostream.html"><code><span style="color: #000">operator&lt;&lt;</span></code></a></td>
<td>ストリームへの出力</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/static_pointer_cast.html"><code><span style="color: #000">static_pointer_cast</span></code></a></td>
<td><code><span style="color: #000">shared_ptr</span></code>の静的キャスト</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/dynamic_pointer_cast.html"><code><span style="color: #000">dynamic_pointer_cast</span></code></a></td>
<td><code><span style="color: #000">shared_ptr</span></code>の動的キャスト</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/const_pointer_cast.html"><code><span style="color: #000">const_pointer_cast</span></code></a></td>
<td><code><span style="color: #000">shared_ptr</span></code>の<code><span style="color: #000">const</span></code>修飾キャスト</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/make_shared.html"><code><span style="color: #000">make_shared</span></code></a></td>
<td><code><span style="color: #000">shared_ptr</span></code>を構築するヘルパ関数</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/allocate_shared.html"><code><span style="color: #000">allocate_shared</span></code></a></td>
<td>アロケータを指定して<code><span style="color: #000">shared_ptr</span></code>を構築するヘルパ関数</td>
<td>C++11</td>
</tr>
</tbody>
</table>
<h2>アトミックアクセス(非メンバ関数)</h2>
<table border="1" bordercolor="#888" style="border-collapse:collapse">
<thead>
<tr>
<th>名前</th>
<th>説明</th>
<th>対応バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_is_lock_free.html"><code><span style="color: #000">atomic_is_lock_free</span></code></a></td>
<td>指定されたオブジェクトがロックフリーに振る舞えるかを調べる</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_store.html"><code><span style="color: #000">atomic_store</span></code></a></td>
<td>値を書き込む</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_store_explicit.html"><code><span style="color: #000">atomic_store_explicit</span></code></a></td>
<td>メモリオーダーを指定して値を書き込む</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_load.html"><code><span style="color: #000">atomic_load</span></code></a></td>
<td>値を読み込む</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_load_explicit.html"><code><span style="color: #000">atomic_load_explicit</span></code></a></td>
<td>メモリオーダーを指定して値を読み込む</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_exchange.html"><code><span style="color: #000">atomic_exchange</span></code></a></td>
<td>値を入れ替える</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_exchange_explicit.html"><code><span style="color: #000">atomic_exchange_explicit</span></code></a></td>
<td>メモリオーダーを指定して値を入れ替える</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_compare_exchange_weak.html"><code><span style="color: #000">atomic_compare_exchange_weak</span></code></a></td>
<td>弱い比較で値の入れ替えを行う</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_compare_exchange_strong.html"><code><span style="color: #000">atomic_compare_exchange_strong</span></code></a></td>
<td>強い比較で値の入れ替えを行う</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_compare_exchange_weak_explicit.html"><code><span style="color: #000">atomic_compare_exchange_weak_explicit</span></code></a></td>
<td>弱い比較でメモリオーダーを指定して値の入れ替えを行う</td>
<td>C++11</td>
</tr>
<tr>
<td><a href="http://cpprefjp.github.io/reference/memory/shared_ptr/atomic_compare_exchange_strong_explicit.html"><code><span style="color: #000">atomic_compare_exchange_strong_explicit</span></code></a></td>
<td>強い比較でメモリオーダーを指定して値の入れ替えを行う</td>
<td>C++11</td>
</tr>
</tbody>
</table>
<h2>ハッシュサポート</h2>
<table border="1" bordercolor="#888" style="border-collapse:collapse">
<thead>
<tr>
<th>名前</th>
<th>説明</th>
<th>対応バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td><code><span style="color: #000">template &lt;class T&gt; struct hash;</span></code></td>
<td><code><span style="color: #000">hash</span></code>クラスの先行宣言</td>
<td>C++11</td>
</tr>
<tr>
<td><code><span style="color: #000">template &lt;class T&gt; struct hash&lt;shared_ptr&lt;N&gt;&gt;;</span></code></td>
<td><code><span style="color: #000">hash</span></code>クラスの<code><span style="color: #000">shared_ptr</span></code>に対する特殊化</td>
<td>C++11</td>
</tr>
</tbody>
</table>
<h2>例</h2>
<p><pre class="codehilite"><code class="language-cpp"><span style="color: #000">#include &lt;iostream&gt;
#include &lt;memory&gt;

int main()
{
  // newしたポインタをshared_ptrオブジェクトに管理させる
  // 所有者は1人。
  std::shared_ptr&lt;int&gt; p1(new int(3));

  {
    // shared_ptrオブジェクトをコピーすることで、
    // 複数のオブジェクトが一つのリソースを共有できる。
    // 所有者が2人になる。
    std::shared_ptr&lt;int&gt; p2 = p1;

    // 共有しているリソースにアクセスする
    std::cout &lt;&lt; *p2 &lt;&lt; std::endl;
  } // p2のデストラクタが実行される。
    // リソースの所有者が1人になる。
    // ここではまだ、リソースは解放されない。

  std::cout &lt;&lt; *p1 &lt;&lt; std::endl;
} // p1のデストラクタが実行される。
  // リソースの所有者が0人になる。
  // 誰もリソースを参照しなくなったので、リソースが解放される。</span></code></pre>
</p>
<h3>出力例</h3>
<p><pre><code><span style="color: #000">3
3
</span></code></pre></p>
<h2>バージョン</h2>
<h3>言語</h3>
<ul>
<li>C++11</li>
</ul>
<h3>処理系</h3>
<ul>
<li><a href="http://cpprefjp.github.io/implementation.html#clang">Clang, C++11 mode</a>: 3.0</li>
<li><a href="http://cpprefjp.github.io/implementation.html#gcc">GCC, C++11 mode</a>: 4.3.6</li>
<li><a href="http://cpprefjp.github.io/implementation.html#icc">ICC</a>: ??</li>
<li><a href="http://cpprefjp.github.io/implementation.html#visual_cpp">Visual C++</a>: 9.0 (TR1), 10.0, 11.0, 12.0</li>
</ul>
<footer><a href="https://github.com/cpprefjp/site/edit/master/reference/memory/shared_ptr.md" target="_blank">編集</a></footer>